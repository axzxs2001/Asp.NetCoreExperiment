<!DOCTYPE html>
<html>
<head>
    <title>小助手</title>

</head>
<body>
    <div class="container" id="mydiv">
    </div>
    <script> 
        var arr = []
        function loadFeachAPI() {
            arr = []
            async function fetchStream(url, data) {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                return new ReadableStream({
                    async start(controller) {
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) {
                                break; // When no more data needs to be consumed, break the loop
                            }
                            const chunk = decoder.decode(value, { stream: true });
                            //console.log(chunk);
                            controller.enqueue(chunk);
                        }
                        reader.releaseLock();
                        controller.close();
                    }
                });
            }

            // 使用函数，你需要提供流的URL
            var jsonContent = '';
            var allString = "";
            const postData = { ask: '请给我生成1到5如下格式的json返回，格式如下：[{"index":1,"value":"1"},{"index":2,"value":"2"}……]。要求只返回json信息，要求完整，不能省略。' };
            fetchStream('/chat', postData).then(stream => {
                const reader = stream.getReader();
                const processChunk = async ({ done, value }) => {
                    if (done) {
                        return;
                    }
                    //console.log(value)
                    jsonContent += value
                    allString = JSON.parse(jsonContent + (value.endsWith("]") ? "" : "]")).join('');
                    //document.getElementById("mydiv").innerHTML += allString + '</br>';
                    processOutput(allString)
                    return reader.read().then(processChunk);
                };
                reader.read().then(processChunk);
            }).catch(e => console.error('There was a problem:', e));
        }
        var buffer = ""
        function processOutput(output) {
            buffer += output; // 将新的输出添加到缓冲区
            const pattern = /\[?{"index":\d+, "value": "\S+"}(, {"index":\d+, "value": "\S+"})*\]?/g;
            let match;
            let lastIndex = 0;
            // 循环查找和处理完整的对象
            while ((match = pattern.exec(buffer)) !== null) {
                var index = JSON.parse(match[0]).index;
                if (!arr.includes(index)) {
                    arr.push(JSON.parse(match[0]).index)
                    console.log('处理对象：', match[0]); // 处理匹配的对象
                }
                lastIndex = match.index + match[0].length;
            }
            // 保留未完成部分在缓冲区中
            buffer = buffer.substring(lastIndex);
        }
        loadFeachAPI()
    </script>
</body>
</html>